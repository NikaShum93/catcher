<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catcher ‚Äî Magic Editor</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
  <link id="gf" rel="stylesheet" href=""> <style>
    :root {
      /* –ú–∞–≥–∏—á–µ—Å–∫–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
      --glass: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.5);
      --primary: #6366f1;   /* Indigo */
      --accent: #f43f5e;    /* Rose */
      --text: #1e1b4b;
      --radius: 20px;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      /* –ñ–∏–≤–æ–π –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω */
      background: linear-gradient(300deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1, #fbc2eb);
      background-size: 400% 400%;
      animation: magicGradient 18s ease infinite;
      
      font-family: 'Nunito', sans-serif;
      color: var(--text);
      height: 100vh;
      display: flex; flex-direction: column; overflow: hidden;
    }
    
    @keyframes magicGradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* === HEADER === */
    header {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.4);
      padding: 12px 24px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
      z-index: 10;
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand h1 { font-weight: 900; font-size: 22px; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.1); margin:0; }

    /* === LAYOUT === */
    main {
      flex: 1; display: grid; grid-template-columns: 440px 1fr; gap: 0; overflow: hidden;
    }
    
    .scroll-col { overflow-y: auto; padding: 24px; padding-bottom: 120px; }
    .sticky-col { 
      overflow-y: auto; padding: 24px; 
      background: rgba(255,255,255,0.15); 
      backdrop-filter: blur(8px); 
      border-left: 1px solid rgba(255,255,255,0.3);
    }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }

    /* === CARDS === */
    .card {
      background: var(--glass);
      border: 1px solid #fff;
      border-radius: var(--radius);
      padding: 22px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 15px 50px -10px rgba(0,0,0,0.12); }
    
    .card h2 { 
      margin: 0 0 16px; font-size: 15px; color: var(--primary); 
      font-weight: 800; text-transform: uppercase; letter-spacing: 1px; 
      display: flex; align-items: center; gap: 8px;
    }

    /* === INPUTS === */
    label { display: block; font-size: 13px; font-weight: 800; color: #555; margin-bottom: 6px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    
    input, select, textarea {
      width: 100%;
      background: #fff;
      border: 2px solid #eef2f6;
      border-radius: 12px;
      padding: 12px;
      font-size: 14px;
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      color: #333;
      transition: all 0.2s;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
    }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
    }
    input[type="color"] { padding: 4px; height: 45px; cursor: pointer; }
    
    /* Checkbox styled */
    .check-row { display: flex; align-items: center; gap: 10px; background: #fff; padding: 8px 12px; border-radius: 12px; border: 2px solid #eef2f6; }
    .check-row input { width: auto; margin: 0; box-shadow: none; }
    .check-row label { margin: 0; cursor: pointer; }

    /* === BUTTONS === */
    button {
      background: linear-gradient(135deg, var(--primary), #818cf8);
      color: #fff; border: none; padding: 14px 24px; border-radius: 14px;
      font-weight: 800; cursor: pointer; font-size: 15px;
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
      transition: transform 0.1s, box-shadow 0.2s;
      width: 100%;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(99, 102, 241, 0.4); }
    button:active { transform: scale(0.97); }
    
    .btn-ghost { 
      background: #fff; color: var(--primary); 
      box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 2px solid transparent; 
    }
    .btn-ghost:hover { border-color: var(--primary); }
    
    .btn-danger { 
      background: #f43f5e; box-shadow: 0 4px 15px rgba(244, 63, 94, 0.3); 
      width: auto; padding: 6px 14px; font-size: 12px; border-radius: 8px;
    }

    /* === PREVIEW (Sticky) === */
    .preview-sticky-wrap { position: sticky; top: 0; z-index: 5; border: 2px solid #fff; background: rgba(255,255,255,0.9); }
    .preview-stage {
      background: repeating-linear-gradient(45deg, #f0fdf4 0, #f0fdf4 10px, #dcfce7 10px, #dcfce7 20px);
      border-radius: 12px; height: 240px;
      display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden; margin-top: 10px; border: 1px dashed #cbd5e1;
    }
    
    /* PREVIEW ITEM - FIX FOR TRANSPARENCY */
    .preview-item {
      position: relative; display: inline-flex; align-items: center; justify-content: center;
      transition: all 0.2s;
      /* –£–¥–∞–ª—è–µ–º padding –æ—Ç—Å—é–¥–∞, –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤ content */
    }
    /* –°–ª–æ–π —Ñ–æ–Ω–∞ (–ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π) */
    .preview-item .bg-layer {
      position: absolute; inset: 0; z-index: 0;
      background-size: cover !important; background-position: center !important;
      transition: opacity 0.2s;
    }
    /* –°–ª–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–≤—Å–µ–≥–¥–∞ –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π) */
    .preview-item .content-layer {
      position: relative; z-index: 1;
      padding: 22px; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø –∑–¥–µ—Å—å */
      display: flex; align-items: center; justify-content: center;
      width: 100%; height: 100%;
    }
    
    /* –§–∏–≥—É—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ —Å–ª–æ—é —Ñ–æ–Ω–∞ */
    .shape-rect .bg-layer { border-radius: 10px; }
    .shape-rounded .bg-layer { border-radius: 20px; }
    .shape-circle .bg-layer { border-radius: 50%; }
    .shape-diamond .bg-layer { clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
    .shape-star .bg-layer { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }

    /* –≠—Ñ—Ñ–µ–∫—Ç—ã */
    .fx-shadow .bg-layer { box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    .fx-glow .bg-layer { box-shadow: 0 0 20px var(--glow); }

    /* === LEVEL === */
    .level {
      background: #fff; border-radius: 16px; padding: 18px; margin-bottom: 12px;
      border-left: 6px solid var(--accent);
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }
    .level-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
    
    /* === PUBLISH === */
    #iframeOut { font-family: monospace; font-size: 11px; background: #333; color: #a5b4fc; border:none; border-radius: 8px; }

  </style>
</head>
<body>

  <header>
    <div class="brand">
      <div style="font-size:24px">‚ú®</div>
      <h1>Catcher <span style="font-weight:400; opacity:0.8">Editor</span></h1>
    </div>
    <button id="saveBtnTop" style="width: auto; padding: 10px 20px;">üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
  </header>

  <main>
    <div class="scroll-col">
      
      <div class="card">
        <h2>üé® –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ & –Ø–∑—ã–∫</h2>
        <div class="row">
          <div>
            <label>–Ø–∑—ã–∫ –∏–≥—Ä—ã</label>
            <select id="language"></select>
          </div>
          <div>
            <label>–®—Ä–∏—Ñ—Ç (–ò–≥—Ä–∏–≤—ã–µ)</label>
            <select id="font"></select>
          </div>
        </div>
        
        <div class="row">
          <div>
            <label>–¶–≤–µ—Ç –§–æ–Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–∞</label>
            <input type="color" id="bgColor" value="#6366f1">
          </div>
          <div>
            <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ñ–æ–Ω–∞</label>
            <input type="range" id="opacity" value="1" step="0.1" min="0" max="1">
            <div style="font-size:11px; text-align:right; color:#888; margin-top:2px">–°–ª–æ–≤–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —è—Ä–∫–∏–º! ‚ú®</div>
          </div>
        </div>
        
        <label>–ò–ª–∏ –ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–∞ —Ñ–æ–Ω (URL)</label>
        <textarea id="bgImages" style="min-height:50px" placeholder="https://..."></textarea>
      </div>

      <div class="card">
        <h2>üîÆ –§–æ—Ä–º–∞ –∏ –ú–∞–≥–∏—è</h2>
        <div class="row">
          <div>
             <label>–§–æ—Ä–º–∞</label>
             <select id="shape">
               <option value="rect">–ö–≤–∞–¥—Ä–∞—Ç</option>
               <option value="rounded" selected>–°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–π</option>
               <option value="circle">–ö—Ä—É–≥</option>
               <option value="diamond">–†–æ–º–±</option>
               <option value="star">–ó–≤–µ–∑–¥–∞</option>
             </select>
          </div>
          <div>
             <label>–†–∞–∑–º–µ—Ä (px)</label>
             <input type="number" id="imgBox" value="160">
          </div>
        </div>

        <div class="row">
          <div class="check-row">
            <input type="checkbox" id="shadowOn" checked>
            <label for="shadowOn">–¢–µ–Ω—å</label>
          </div>
          <div class="check-row">
            <input type="checkbox" id="fx3d">
            <label for="fx3d">3D –û–±—ä–µ–º</label>
          </div>
        </div>
        
        <div class="row" style="align-items:center">
           <div class="check-row">
             <input type="checkbox" id="glowOn">
             <label for="glowOn">–ù–µ–æ–Ω</label>
           </div>
           <input type="color" id="glowColor" value="#ff00ff" style="height:42px">
        </div>

        <div class="row" style="align-items:center">
           <div class="check-row">
             <input type="checkbox" id="borderOn" checked>
             <label for="borderOn">–†–∞–º–∫–∞</label>
           </div>
           <input type="color" id="borderColor" value="#ffffff" style="height:42px">
        </div>
        
        <div class="row">
           <div>
             <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
             <input type="color" id="textColor" value="#ffffff">
           </div>
           <div>
             <label>–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞</label>
             <input type="number" id="fontSize" value="28">
           </div>
        </div>
      </div>

      <div class="card" style="border: 2px dashed var(--primary); background: rgba(99, 102, 241, 0.05);">
        <h2>ü¶∏‚Äç‚ôÇÔ∏è –ì–ª–∞–≤–Ω—ã–π –ì–µ—Ä–æ–π</h2>
        <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL, GIF)</label>
        <input type="url" id="playerImg" placeholder="https://.../cat.gif">
        <div style="font-size:12px; margin-top:6px; color:#666">–ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ª–æ–≤–∏–º –∫–ª–∏–∫–æ–º –º—ã—à–∫–∏/–ø–∞–ª—å—Ü–∞.</div>
        
        <div class="row" style="margin-top:12px">
          <div>
            <label>–®–∏—Ä–∏–Ω–∞ (px)</label>
            <input type="number" id="playerWidth" value="120">
          </div>
          <div>
            <label>–í—ã—Å–æ—Ç–∞ (px)</label>
            <input type="number" id="playerHeight" value="120">
          </div>
        </div>
      </div>

      <div class="card">
        <h2>‚öôÔ∏è –ì–µ–π–º–ø–ª–µ–π</h2>
        <div class="row">
          <div>
            <label>–°–∫–æ—Ä–æ—Å—Ç—å (1-10)</label>
            <input type="number" id="speed" value="5" min="1" max="10">
          </div>
          <div>
            <label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
            <select id="direction">
              <option value="down">–í–Ω–∏–∑ ‚¨áÔ∏è</option>
              <option value="up">–í–≤–µ—Ä—Ö ‚¨ÜÔ∏è</option>
            </select>
          </div>
        </div>
        
        <div class="row">
          <div>
            <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ä—Ç–∞</label>
            <input type="text" id="startTitle" placeholder="–ü–æ–π–º–∞–π –∏—Ö –≤—Å–µ—Ö!">
          </div>
          <div>
             <label>–¢–µ–∫—Å—Ç –ø–æ–±–µ–¥—ã</label>
             <input type="text" id="finalFeedback" placeholder="–¢—ã —Å—É–ø–µ—Ä!">
          </div>
        </div>
      </div>

    </div>

    <div class="sticky-col">
      
      <div class="card preview-sticky-wrap">
        <h2 style="font-size:12px; color:#888; margin-bottom:10px">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≠–ª–µ–º–µ–Ω—Ç–∞</h2>
        <div class="row" style="margin-bottom:0; gap:8px">
           <input type="text" id="previewValue" value="Magic">
           <div style="display:flex; gap:4px">
             <button class="btn-ghost" id="btnText" style="width:auto; padding:0 12px">T</button>
             <button class="btn-ghost" id="btnImage" style="width:auto; padding:0 12px">üñºÔ∏è</button>
           </div>
        </div>

        <div class="preview-stage">
          <div id="previewItem" class="preview-item shape-rounded fx-shadow" style="--glow:#ff00ff;">
            <div class="bg-layer"></div> <div class="content-layer"> <span id="previewText" style="font-weight:700; font-size:28px">Magic</span>
            </div>
          </div>
        </div>
      </div>

      <div id="levels"></div>
      
      <button id="addLevel" class="btn-ghost" style="border: 2px dashed #ccc; margin-bottom: 24px; color:#666">
        ‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å
      </button>

      <div class="card" style="background:#1e1b4b; color:white; border:none">
        <h2 style="color:#a5b4fc">üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è</h2>
        <button id="saveBtn" style="margin-bottom:12px">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ò–≥—Ä—É</button>
        <button id="copyBtn" class="btn-ghost" style="background:rgba(255,255,255,0.1); color:#fff; font-size:12px; margin-bottom:8px">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
        <textarea id="iframeOut" readonly onclick="this.select()" placeholder="–ö–æ–¥ –¥–ª—è Genially –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."></textarea>
      </div>

    </div>
  </main>

  <script>
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    // üî• –ë–û–õ–¨–®–ê–Ø –ë–ê–ó–ê –ò–ì–†–ò–í–´–• –®–†–ò–§–¢–û–í –ü–û –Ø–ó–´–ö–ê–ú
    const FONT_MAP = {
      ru: [
        "Nunito", "Rubik", "Comfortaa", "Pacifico", "Lobster", "Caveat", "Amatic SC", "Russo One", 
        "Press Start 2P", "Montserrat", "Balsamiq Sans"
      ],
      en: [
        "Nunito", "Fredoka One", "Bangers", "Creepster", "Monoton", "Righteous", "Orbitron", 
        "Sacramento", "Indie Flower", "Patrick Hand", "Titan One", "Bubblegum Sans"
      ],
      ja: ["Dela Gothic One", "Kosugi Maru", "Kiwi Maru", "DotGothic16", "Noto Sans JP"],
      zh: ["ZCOOL KuaiLe", "Ma Shan Zheng", "ZCOOL QingKe HuangYou", "Noto Sans SC"],
      de: ["Fredoka One", "Patrick Hand", "Bangers", "Rubik", "Open Sans"],
      it: ["Lobster", "Montserrat", "Lato", "Playfair Display", "Patrick Hand"],
      es: ["Pacifico", "Amatic SC", "Montserrat", "Bangers", "Titan One"],
      fr: ["Parisienne", "Comfortaa", "Montserrat", "Patrick Hand", "Rubik"],
      math: ["Latin Modern Math", "Rubik"]
    };

    const LANG_NAMES = {
      ru: "–†—É—Å—Å–∫–∏–π üá∑üá∫", en: "English üá¨üáß", ja: "Êó•Êú¨Ë™û üáØüáµ", zh: "‰∏≠Êñá üá®üá≥", 
      de: "Deutsch üá©üá™", it: "Italiano üáÆüáπ", es: "Espa√±ol üá™üá∏", fr: "Fran√ßais üá´üá∑", math: "Math üìê"
    };

    function init(){
      fillLanguageSelect();
      fillFontsForLanguage('ru');
      addLevel();
      applyGoogleFont('Nunito');
      updatePreview();
      
      // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
      $$('input, select, textarea').forEach(el => {
        el.oninput = updatePreview;
        el.onchange = updatePreview;
      });
      
      $('#btnText').onclick = () => { $('#previewItem').dataset.mode='text'; updatePreview(); };
      $('#btnImage').onclick = () => { $('#previewItem').dataset.mode='image'; updatePreview(); };
      $('#addLevel').onclick = addLevel;
      $('#saveBtn').onclick = publish;
      $('#saveBtnTop').onclick = publish;
      $('#copyBtn').onclick = () => { $('#iframeOut').select(); document.execCommand('copy'); };
      
      // –°–º–µ–Ω–∞ —è–∑—ã–∫–∞ –º–µ–Ω—è–µ—Ç —à—Ä–∏—Ñ—Ç—ã
      $('#language').onchange = (e) => {
        fillFontsForLanguage(e.target.value);
        updatePreview();
      };
      // –°–º–µ–Ω–∞ —à—Ä–∏—Ñ—Ç–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –µ–≥–æ
      $('#font').onchange = (e) => {
        applyGoogleFont(e.target.value);
        updatePreview();
      };
    }

    function fillLanguageSelect(){
      const sel = $('#language');
      sel.innerHTML = Object.keys(FONT_MAP).map(k => `<option value="${k}">${LANG_NAMES[k]}</option>`).join('');
    }

    function fillFontsForLanguage(lang){
      const sel = $('#font');
      const list = FONT_MAP[lang] || FONT_MAP.en;
      sel.innerHTML = list.map(f => `<option>${f}</option>`).join('');
      sel.value = list[0];
    }

    function applyGoogleFont(fontName){
      $('#gf').href = `https://fonts.googleapis.com/css2?family=${fontName.replace(/ /g,'+')}:wght@400;700&display=swap`;
      const txt = $('#previewText');
      txt.style.fontFamily = `"${fontName}", system-ui`;
    }

    // üî• –û–ë–ù–û–í–õ–ï–ù–ù–´–ô PREVIEW (–ü–†–û–ó–†–ê–ß–ù–û–°–¢–¨ –¢–û–õ–¨–ö–û –£ –§–û–ù–ê)
    function updatePreview(){
      const item = $('#previewItem');
      const bgLayer = item.querySelector('.bg-layer');
      const contentLayer = item.querySelector('.content-layer');
      const text = $('#previewText');
      const val  = $('#previewValue').value;
      const isImg = item.dataset.mode === 'image';

      // –ö–ª–∞—Å—Å—ã —Ñ–æ—Ä–º—ã –∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
      item.className = `preview-item shape-${$('#shape').value}`;
      if($('#shadowOn').checked) item.classList.add('fx-shadow');
      if($('#fx3d').checked) item.classList.add('fx-3d');
      if($('#glowOn').checked) {
        item.classList.add('fx-glow');
        item.style.setProperty('--glow', $('#glowColor').value);
      } else item.classList.remove('fx-glow');

      // –†–∞–º–∫–∞ (–ø—Ä–∏–º–µ–Ω—è–µ–º –∫ —Å–ª–æ—é —Ñ–æ–Ω–∞)
      if($('#borderOn').checked){
        bgLayer.style.border = `2px solid ${$('#borderColor').value}`; 
      } else bgLayer.style.border = 'none';

      // –§–æ–Ω
      const bgList = ($('#bgImages').value||'').split('\n').filter(s=>s.trim().startsWith('http'));
      if(bgList.length){
        bgLayer.style.backgroundImage = `url(${bgList[0]})`;
        bgLayer.style.backgroundColor = 'transparent';
      } else {
        bgLayer.style.backgroundImage = 'none';
        bgLayer.style.backgroundColor = $('#bgColor').value;
      }
      
      // ‚úÖ FIX: –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ —É —Å–ª–æ—è —Ñ–æ–Ω–∞!
      bgLayer.style.opacity = $('#opacity').value;

      // –°—Ç–∏–ª–∏ —Ç–µ–∫—Å—Ç–∞
      text.style.color = $('#textColor').value;
      text.style.fontSize = $('#fontSize').value + 'px';
      text.style.fontFamily = `"${$('#font').value}", system-ui`;

      // –ö–æ–Ω—Ç–µ–Ω—Ç (–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∏–ª–∏ –¢–µ–∫—Å—Ç)
      if(isImg || val.startsWith('http')){
        contentLayer.innerHTML = `<img src="${val.startsWith('http')?val:'https://via.placeholder.com/150'}" style="width:100%;height:100%;object-fit:contain">`;
        const sz = $('#imgBox').value || 160;
        item.style.width = sz+'px'; item.style.height = sz+'px';
      } else {
        contentLayer.innerHTML = '';
        contentLayer.appendChild(text);
        text.textContent = val;
        item.style.width = 'auto'; item.style.height = 'auto';
        item.style.minWidth = '120px'; item.style.minHeight = '80px';
      }
    }

    function levelTemplate(i){
      const div = document.createElement('div');
      div.className = 'level';
      div.innerHTML = `
        <div class="level-header">
           <h3 style="margin:0; font-size:14px; color:#444">–£–†–û–í–ï–ù–¨ ${i+1}</h3>
           <button class="btn-danger del">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
        <input type="text" class="target" placeholder="–¶–µ–ª—å —É—Ä–æ–≤–Ω—è (–Ω–∞–ø—Ä: –§—Ä—É–∫—Ç—ã)" style="margin-bottom:8px">
        <div class="row">
           <textarea class="correct" placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω–æ..."></textarea>
           <textarea class="wrong" placeholder="–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ..."></textarea>
        </div>
        <label>–¢–∞–π–º–µ—Ä (—Å–µ–∫)</label>
        <input type="number" class="timer" value="30" style="width:80px">
      `;
      div.querySelector('.del').onclick = () => { div.remove(); };
      return div;
    }

    function addLevel(){ $('#levels').appendChild(levelTemplate($$('#levels .level').length)); }

    function collectConfig(){
      const levels = [];
      $$('.level').forEach(l => {
        levels.push({
          target: l.querySelector('.target').value.trim(),
          correct: l.querySelector('.correct').value.split('\n').filter(s=>s.trim()),
          wrong: l.querySelector('.wrong').value.split('\n').filter(s=>s.trim()),
          timer: l.querySelector('.timer').value
        });
      });

      return {
        language: $('#language').value,
        font: $('#font').value,
        fontSize: $('#fontSize').value,
        textColor: $('#textColor').value,
        speed: $('#speed').value,
        style: {
          shape: $('#shape').value,
          bgColor: $('#bgColor').value,
          bgImages: ($('#bgImages').value||'').split('\n').filter(s=>s.trim()),
          borderOn: $('#borderOn').checked,
          borderColor: $('#borderColor').value,
          shadow: $('#shadowOn').checked,
          glow: $('#glowOn').checked,
          glowColor: $('#glowColor').value,
          fx3d: $('#fx3d').checked,
          opacity: $('#opacity').value, // –ø–µ—Ä–µ–¥–∞–µ–º –æ–ø–∞—Å–∏—Ç–∏ —Ñ–æ–Ω–∞
          imgBox: $('#imgBox').value
        },
        player: {
          img: $('#playerImg').value.trim(),
          width: $('#playerWidth').value,
          height: $('#playerHeight').value
        },
        direction: $('#direction').value,
        start: { title: $('#startTitle').value, btnText: "Start" },
        finalFeedback: $('#finalFeedback').value,
        levels: levels
      };
    }

    const ENDPOINT = "https://server-kjnn.onrender.com/publish";
    const KEY = "nika_read_pub_2025";
    const BASE = "https://nikashum93.github.io/catcher/main.html";

    async function publish(){
      const cfg = collectConfig();
      if(!cfg.levels.length || !cfg.levels[0].target) return alert("–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã 1 —É—Ä–æ–≤–µ–Ω—å —Å —Ü–µ–ª—å—é!");
      
      const btn = $('#saveBtnTop');
      const oldTxt = btn.textContent;
      btn.textContent = "‚è≥...";
      btn.disabled = true;

      const id = (cfg.levels[0].target.replace(/[^a-z0-9]/gi,'-') + '-' + Date.now()).toLowerCase();
      
      try {
        const res = await fetch(ENDPOINT, {
           method:'POST',
           headers: {'Content-Type':'application/json', 'X-Publish-Key': KEY},
           body: JSON.stringify({ id, mode:'json', folder:'data', content: JSON.stringify(cfg) })
        });
        if(!res.ok) throw new Error();
        
        const code = `<iframe src="${BASE}?id=${id}" width="900" height="600" style="border:0" allow="autoplay; fullscreen"></iframe>`;
        $('#iframeOut').value = code;
        alert("‚úÖ –ò–≥—Ä–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞! –°–∫–æ–ø–∏—Ä—É–π –∫–æ–¥.");
      } catch(e) {
        alert("‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.");
      }
      btn.textContent = oldTxt;
      btn.disabled = false;
    }
    
    init();
  </script>
</body>
</html>
