<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ü¶Ñ Magic Editor</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
  <link id="gf" rel="stylesheet" href="">

  <style>
    :root {
      /* –ü–∞–ª–∏—Ç—Ä–∞ –ï–¥–∏–Ω–æ—Ä–æ–≥–∞ */
      --glass: rgba(255, 255, 255, 0.1);
      --glass-strong: rgba(255, 255, 255, 0.2);
      --border: rgba(255, 255, 255, 0.3);
      --neon-pink: #ff00ff;
      --neon-cyan: #00ffff;
      --text: #ffffff;
      --text-soft: rgba(255,255,255,0.7);
      --radius: 24px;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      /* –¢—Ä–∞–Ω—Å—Ü–µ–Ω–¥–µ–Ω—Ç–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
      background: linear-gradient(135deg, #2e0249, #570a57, #a91079, #f806cc, #2e0249);
      background-size: 400% 400%;
      animation: dreamFlow 20s ease infinite;
      
      font-family: 'Quicksand', sans-serif;
      color: var(--text);
      height: 100vh;
      display: flex; flex-direction: column; overflow: hidden;
    }
    
    @keyframes dreamFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* –ü–£–ó–´–†–ò–ö–ò –ù–ê –§–û–ù–ï */
    .bubbles {
      position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden;
    }
    .bubble {
      position: absolute; bottom: -100px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), rgba(255,255,255,0.1));
      box-shadow: 0 0 10px rgba(255,255,255,0.3);
      border-radius: 50%;
      animation: floatUp linear infinite;
    }
    @keyframes floatUp {
      0% { transform: translateY(0) scale(1); opacity: 0; }
      10% { opacity: 0.7; }
      90% { opacity: 0.7; }
      100% { transform: translateY(-120vh) scale(1.5); opacity: 0; }
    }

    /* === HEADER === */
    header {
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 15px 30px;
      display: flex; align-items: center; justify-content: space-between;
      z-index: 10;
      box-shadow: 0 5px 30px rgba(0,0,0,0.2);
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand h1 { 
      font-weight: 800; font-size: 22px; margin:0; 
      background: linear-gradient(to right, #fff, var(--neon-cyan));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      text-shadow: 0 0 20px var(--neon-pink);
    }

    /* === LAYOUT === */
    main {
      flex: 1; display: grid; grid-template-columns: 480px 1fr; gap: 0; 
      overflow: hidden; z-index: 1; /* –ü–æ–≤–µ—Ä—Ö –ø—É–∑—ã—Ä–µ–π */
    }
    
    .scroll-col { 
      overflow-y: auto; padding: 30px; padding-bottom: 150px; 
      border-right: 1px solid var(--border);
      background: rgba(0,0,0,0.1);
    }
    .sticky-col { 
      overflow-y: auto; padding: 30px; 
      background: rgba(255,255,255,0.02); 
    }

    /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
    ::-webkit-scrollbar-thumb { 
      background: linear-gradient(to bottom, var(--neon-pink), var(--neon-cyan)); 
      border-radius: 10px; 
    }

    /* === GLASS CARDS === */
    .card {
      background: var(--glass);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.3);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .card:hover { 
      transform: translateY(-5px); 
      box-shadow: 0 15px 50px rgba(0,255,255,0.15); 
      border-color: var(--neon-cyan);
    }
    .card h2 { 
      margin: 0 0 20px; font-size: 16px; color: var(--neon-cyan); 
      font-weight: 700; text-transform: uppercase; letter-spacing: 2px; 
      display: flex; align-items: center; gap: 10px;
      text-shadow: 0 0 10px rgba(0,255,255,0.5);
    }

    /* === INPUTS === */
    label { display: block; font-size: 13px; font-weight: 700; color: var(--text-soft); margin-bottom: 8px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    
    input, select, textarea {
      width: 100%;
      background: rgba(0,0,0,0.3);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 15px; font-family: 'Nunito', sans-serif; font-weight: 600;
      color: #fff; transition: all 0.3s;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
    }
    input:focus, select:focus, textarea:focus {
      outline: none; 
      border-color: var(--neon-pink); 
      box-shadow: 0 0 15px rgba(255,0,255,0.4);
      background: rgba(0,0,0,0.5);
    }
    input[type="color"] { padding: 4px; height: 45px; cursor: pointer; }
    textarea { resize: vertical; min-height: 90px; }
    
    .check-row { 
      display: flex; align-items: center; gap: 12px; 
      background: rgba(255,255,255,0.05); padding: 10px 14px; 
      border-radius: 12px; border: 1px solid var(--border); 
      cursor: pointer; transition: 0.3s;
    }
    .check-row:hover { background: rgba(255,255,255,0.15); border-color: var(--neon-pink); }
    .check-row input { width: auto; margin: 0; box-shadow:none; }
    .check-row label { margin: 0; cursor: pointer; color: #fff; }

    /* === BUTTONS === */
    button {
      background: linear-gradient(90deg, #ff00cc, #3333ff);
      color: #fff; border: none; padding: 14px 24px; border-radius: 16px;
      font-weight: 800; cursor: pointer; font-size: 15px; text-transform: uppercase; letter-spacing: 1px;
      box-shadow: 0 0 20px rgba(255, 0, 204, 0.4);
      transition: all 0.3s; width: 100%; position: relative; overflow: hidden;
    }
    button::after {
      content:''; position: absolute; top:0; left:-100%; width:100%; height:100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: 0.5s;
    }
    button:hover::after { left: 100%; }
    button:hover { transform: scale(1.02); box-shadow: 0 0 30px rgba(51, 51, 255, 0.6); }
    
    .btn-ghost { 
      background: rgba(255,255,255,0.1); color: #fff; 
      box-shadow: none; border: 1px solid var(--border); 
    }
    .btn-ghost:hover { background: rgba(255,255,255,0.2); border-color: #fff; }
    .btn-danger { background: rgba(255, 50, 50, 0.3); border: 1px solid #ff3333; color: #ffadad; width: auto; padding: 6px 14px; font-size: 12px; }

    /* === PREVIEW === */
    .preview-sticky-wrap { 
      position: sticky; top: 0; z-index: 5; 
      border: 2px solid var(--neon-cyan); 
      background: rgba(0,0,0,0.6);
      box-shadow: 0 0 30px rgba(0,255,255,0.2);
    }
    .preview-stage {
      /* –®–∞—Ö–º–∞—Ç–∫–∞ –¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ */
      background-color: #1a1a2e;
      background-image: radial-gradient(#ffffff 1px, transparent 1px);
      background-size: 20px 20px;
      border-radius: 16px; height: 240px;
      display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden; margin-top: 15px; 
      border: 1px dashed rgba(255,255,255,0.3);
    }
    
    /* PREVIEW ITEM */
    .preview-item {
      position: relative; display: inline-flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .preview-item .bg-layer {
      position: absolute; inset: 0; z-index: 0;
      background-size: cover !important; background-position: center !important;
      transition: opacity 0.2s;
    }
    .preview-item .content-layer {
      position: relative; z-index: 1; padding: 12px; 
      display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;
    }
    
    .shape-rect .bg-layer { border-radius: 12px; }
    .shape-rounded .bg-layer { border-radius: 30px; }
    .shape-circle .bg-layer { border-radius: 50%; }
    .shape-diamond .bg-layer { clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
    .shape-star .bg-layer { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }

    .fx-shadow .bg-layer { box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
    .fx-glow .bg-layer { box-shadow: 0 0 20px var(--glow), inset 0 0 10px var(--glow); }

    /* === LEVELS === */
    .level {
      background: rgba(255, 255, 255, 0.07); border: 1px solid var(--border);
      border-radius: 16px; padding: 20px; margin-bottom: 15px;
      border-left: 5px solid var(--neon-pink);
    }
    .level-header { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; }
    .level h3 { margin: 0; font-size: 16px; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
    
    /* === PUBLISH === */
    #iframeOut { font-family: monospace; font-size: 12px; background: #000; color: #00ff00; border: 1px solid #333; }
    .hint { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 5px; }

  </style>
</head>
<body>

  <div class="bubbles" id="bubbles"></div>

  <header>
    <div class="brand">
      <span style="font-size:28px">ü¶Ñ</span>
      <h1>Magic Catcher</h1>
    </div>
    <button id="saveBtnTop" style="width: auto; padding: 10px 25px;">‚ú® –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
  </header>

  <main>
    <div class="scroll-col">
      
      <div class="card">
        <h2><span>üéÆ</span> –ì–µ–π–º–ø–ª–µ–π</h2>
        <div class="row">
          <div>
            <label>–Ø–∑—ã–∫</label>
            <select id="language"></select>
          </div>
          <div>
            <label>–®—Ä–∏—Ñ—Ç</label>
            <select id="font"></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>–°–∫–æ—Ä–æ—Å—Ç—å (1‚Äì10)</label>
            <input type="number" id="speed" value="5" min="1" max="10">
          </div>
          <div>
            <label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
            <select id="direction">
              <option value="down">‚¨áÔ∏è –°–≤–µ—Ä—Ö—É –í–ù–ò–ó</option>
              <option value="up">‚¨ÜÔ∏è –°–Ω–∏–∑—É –í–í–ï–†–•</option>
              <option value="left">‚¨ÖÔ∏è –°–ø—Ä–∞–≤–∞ –ù–ê–õ–ï–í–û</option>
              <option value="right">‚û°Ô∏è –°–ª–µ–≤–∞ –ù–ê–ü–†–ê–í–û</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card" style="border-color: var(--neon-pink);">
        <h2><span>ü¶∏‚Äç‚ôÇÔ∏è</span> –ì–µ—Ä–æ–π</h2>
        <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ –≥–µ—Ä–æ—è (URL)</label>
        <input type="url" id="playerImg" placeholder="https://.../unicorn.gif">
        <div class="hint">–ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –∏–≥—Ä–∞–µ–º –∫–ª–∏–∫–∞–º–∏ (–±–µ–∑ –≥–µ—Ä–æ—è).</div>
        
        <div class="row" style="margin-top:12px">
          <div>
            <label>–®–∏—Ä–∏–Ω–∞ (px)</label>
            <input type="number" id="playerWidth" value="120">
          </div>
          <div>
            <label>–í—ã—Å–æ—Ç–∞ (px)</label>
            <input type="number" id="playerHeight" value="120">
          </div>
        </div>
      </div>

      <div class="card">
        <h2><span>üé®</span> –í–∏–¥ —ç–ª–µ–º–µ–Ω—Ç–æ–≤</h2>
        <div class="row">
          <div>
             <label>–§–æ—Ä–º–∞</label>
             <select id="shape">
               <option value="rect">–ö–≤–∞–¥—Ä–∞—Ç</option>
               <option value="rounded" selected>–°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–π</option>
               <option value="circle">–ö—Ä—É–≥</option>
               <option value="diamond">–†–æ–º–±</option>
               <option value="star">–ó–≤–µ–∑–¥–∞</option>
             </select>
          </div>
          <div>
             <label>–†–∞–∑–º–µ—Ä –∫–∞—Ä—Ç–∏–Ω–∫–∏ (px)</label>
             <input type="number" id="imgBox" value="160">
          </div>
        </div>

        <div class="row">
          <div>
            <label>–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label>
            <input type="color" id="bgColor" value="#6366f1">
          </div>
          <div>
            <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ñ–æ–Ω–∞</label>
            <input type="range" id="opacity" value="1" step="0.1" min="0" max="1">
          </div>
        </div>
        
        <label>–§–æ–Ω–æ–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ (URL)</label>
        <textarea id="bgImages" style="min-height:60px" placeholder="https://..."></textarea>
        
        <div class="row" style="margin-top:12px">
           <div><label>–û—Ç—Å—Ç—É–ø –≤–Ω—É—Ç—Ä–∏ (px)</label><input type="number" id="pad" value="22"></div>
        </div>
      </div>

      <div class="card">
        <h2><span>‚ú®</span> –ú–∞–≥–∏—è –∏ –≠—Ñ—Ñ–µ–∫—Ç—ã</h2>
        <div class="row-3">
           <div class="check-row">
             <input type="checkbox" id="borderOn" checked>
             <label for="borderOn">–†–∞–º–∫–∞</label>
           </div>
           <input type="color" id="borderColor" value="#ffffff" style="height:46px">
           <input type="number" id="borderWidth" value="2" placeholder="px">
        </div>

        <div class="row">
          <div class="check-row">
            <input type="checkbox" id="shadowOn" checked>
            <label for="shadowOn">–¢–µ–Ω—å</label>
          </div>
          <div class="check-row">
            <input type="checkbox" id="fx3d">
            <label for="fx3d">3D –û–±—ä–µ–º</label>
          </div>
        </div>
        
        <div class="row" style="align-items:center">
           <div class="check-row">
             <input type="checkbox" id="glowOn">
             <label for="glowOn">–ù–µ–æ–Ω</label>
           </div>
           <input type="color" id="glowColor" value="#ff00ff" style="height:46px">
        </div>
      </div>

      <div class="card">
        <h2><span>üî§</span> –¢–µ–∫—Å—Ç</h2>
        <div class="row">
           <div>
             <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
             <input type="color" id="textColor" value="#ffffff">
           </div>
           <div>
             <label>–†–∞–∑–º–µ—Ä (px)</label>
             <input type="number" id="fontSize" value="28">
           </div>
        </div>
      </div>

      <div class="card">
        <h2><span>üí¨</span> –°–æ–æ–±—â–µ–Ω–∏—è</h2>
        <div class="row">
          <div>
            <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ä—Ç–∞</label>
            <input type="text" id="startTitle" placeholder="Magic Game!">
          </div>
          <div>
             <label>–ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ä—Ç–∞</label>
             <input type="text" id="startBtnText" placeholder="Start">
          </div>
        </div>
        <label>–§–∏–Ω–∞–ª (–¢–µ–∫—Å—Ç –∏–ª–∏ –ö–∞—Ä—Ç–∏–Ω–∫–∞)</label>
        <textarea id="finalFeedback" placeholder="You are amazing!"></textarea>
      </div>

    </div>

    <div class="sticky-col">
      
      <div class="card preview-sticky-wrap">
        <h2 style="font-size:12px; color:#aaa; margin-bottom:10px; border:none">–ü–†–ï–î–ü–†–û–°–ú–û–¢–†</h2>
        <div class="row" style="margin-bottom:0; gap:8px">
           <input type="text" id="previewValue" value="Dream">
           <div style="display:flex; gap:4px">
             <button class="btn-ghost" id="btnText" style="width:auto; padding:0 12px">T</button>
             <button class="btn-ghost" id="btnImage" style="width:auto; padding:0 12px">üñºÔ∏è</button>
           </div>
        </div>

        <div class="preview-stage">
          <div id="previewItem" class="preview-item shape-rounded fx-shadow" style="--glow:#ff00ff;">
            <div class="bg-layer"></div>
            <div class="content-layer">
               <span id="previewText" style="font-weight:700; font-size:28px">Dream</span>
            </div>
          </div>
        </div>
      </div>

      <div id="levels"></div>
      
      <button id="addLevel" class="btn-ghost" style="border: 2px dashed rgba(255,255,255,0.3); margin-bottom: 24px; color:#fff">
        ‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å
      </button>

      <div class="card" style="background:#0f172a; border-color:var(--neon-cyan)">
        <h2 style="color:var(--neon-cyan)">üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è</h2>
        <button id="saveBtn" style="margin-bottom:12px">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ò–≥—Ä—É</button>
        <button id="copyBtn" class="btn-ghost" style="font-size:12px; margin-bottom:8px">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
        <textarea id="iframeOut" readonly onclick="this.select()" placeholder="–ö–æ–¥ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏..."></textarea>
      </div>

    </div>
  </main>

  <script>
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    // ‚ú® –ì–ï–ù–ï–†–ê–¢–û–† –ü–£–ó–´–†–ï–ô
    function createBubbles() {
      const container = document.getElementById('bubbles');
      const bubbleCount = 20;
      for (let i = 0; i < bubbleCount; i++) {
        const b = document.createElement('div');
        b.className = 'bubble';
        const size = Math.random() * 60 + 20;
        b.style.width = size + 'px';
        b.style.height = size + 'px';
        b.style.left = Math.random() * 100 + '%';
        b.style.animationDuration = (Math.random() * 10 + 10) + 's';
        b.style.animationDelay = (Math.random() * 10) + 's';
        container.appendChild(b);
      }
    }

    // –®–†–ò–§–¢–´
    const FONT_MAP = {
      ru: ["Nunito", "Rubik", "Comfortaa", "Pacifico", "Lobster", "Caveat", "Amatic SC", "Russo One", "Press Start 2P", "Montserrat"],
      en: ["Nunito", "Quicksand", "Fredoka One", "Bangers", "Creepster", "Monoton", "Righteous", "Orbitron", "Sacramento", "Indie Flower"],
      ja: ["Dela Gothic One", "Kosugi Maru", "Kiwi Maru", "DotGothic16", "Noto Sans JP"],
      zh: ["ZCOOL KuaiLe", "Ma Shan Zheng", "ZCOOL QingKe HuangYou", "Noto Sans SC"],
      de: ["Fredoka One", "Patrick Hand", "Bangers", "Rubik", "Open Sans"],
      it: ["Lobster", "Montserrat", "Lato", "Playfair Display", "Patrick Hand"],
      es: ["Pacifico", "Amatic SC", "Montserrat", "Bangers", "Titan One"],
      fr: ["Parisienne", "Comfortaa", "Montserrat", "Patrick Hand", "Rubik"],
      math: ["Latin Modern Math", "Rubik"]
    };

    const LANG_NAMES = {
      ru: "–†—É—Å—Å–∫–∏–π üá∑üá∫", en: "English üá¨üáß", ja: "Êó•Êú¨Ë™û üáØüáµ", zh: "‰∏≠Êñá üá®üá≥", 
      de: "Deutsch üá©üá™", it: "Italiano üáÆüáπ", es: "Espa√±ol üá™üá∏", fr: "Fran√ßais üá´üá∑", math: "Math üìê"
    };

    function init(){
      createBubbles();
      fillLanguageSelect();
      fillFontsForLanguage('ru');
      addLevel();
      applyGoogleFont('Nunito');
      updatePreview();
      
      // Listeners
      $$('input, select, textarea').forEach(el => {
        el.oninput = updatePreview;
        el.onchange = updatePreview;
      });
      
      $('#btnText').onclick = () => { $('#previewItem').dataset.mode='text'; updatePreview(); };
      $('#btnImage').onclick = () => { $('#previewItem').dataset.mode='image'; updatePreview(); };
      $('#addLevel').onclick = addLevel;
      $('#saveBtn').onclick = publish;
      $('#saveBtnTop').onclick = publish;
      $('#copyBtn').onclick = () => { $('#iframeOut').select(); document.execCommand('copy'); };
      
      $('#language').onchange = (e) => { fillFontsForLanguage(e.target.value); updatePreview(); };
      $('#font').onchange = (e) => { applyGoogleFont(e.target.value); updatePreview(); };
    }

    function fillLanguageSelect(){
      const sel = $('#language');
      sel.innerHTML = Object.keys(FONT_MAP).map(k => `<option value="${k}">${LANG_NAMES[k]}</option>`).join('');
    }

    function fillFontsForLanguage(lang){
      const sel = $('#font');
      const list = FONT_MAP[lang] || FONT_MAP.en;
      sel.innerHTML = list.map(f => `<option>${f}</option>`).join('');
      sel.value = list[0];
    }

    function applyGoogleFont(fontName){
      $('#gf').href = `https://fonts.googleapis.com/css2?family=${fontName.replace(/ /g,'+')}:wght@400;700&display=swap`;
      const txt = $('#previewText');
      txt.style.fontFamily = `"${fontName}", system-ui`;
    }

    function updatePreview(){
      const item = $('#previewItem');
      const bgLayer = item.querySelector('.bg-layer');
      const contentLayer = item.querySelector('.content-layer');
      const text = $('#previewText');
      const val  = $('#previewValue').value;
      const isImg = item.dataset.mode === 'image';

      item.className = `preview-item shape-${$('#shape').value}`;
      if($('#shadowOn').checked) item.classList.add('fx-shadow');
      if($('#fx3d').checked) item.classList.add('fx-3d');
      if($('#glowOn').checked) {
        item.classList.add('fx-glow');
        item.style.setProperty('--glow', $('#glowColor').value);
      } else item.classList.remove('fx-glow');

      if($('#borderOn').checked){
        bgLayer.style.border = `${$('#borderWidth').value}px solid ${$('#borderColor').value}`; 
      } else bgLayer.style.border = 'none';

      const bgList = ($('#bgImages').value||'').split('\n').filter(s=>s.trim().startsWith('http'));
      if(bgList.length){
        bgLayer.style.backgroundImage = `url(${bgList[0]})`;
        bgLayer.style.backgroundColor = 'transparent';
      } else {
        bgLayer.style.backgroundImage = 'none';
        bgLayer.style.backgroundColor = $('#bgColor').value;
      }
      
      bgLayer.style.opacity = $('#opacity').value;

      text.style.color = $('#textColor').value;
      text.style.fontSize = $('#fontSize').value + 'px';
      text.style.fontFamily = `"${$('#font').value}", system-ui`;

      if(isImg || val.startsWith('http')){
        contentLayer.innerHTML = `<img src="${val.startsWith('http')?val:'https://via.placeholder.com/150'}" style="width:100%;height:100%;object-fit:contain">`;
        const sz = $('#imgBox').value || 160;
        item.style.width = sz+'px'; item.style.height = sz+'px';
      } else {
        contentLayer.innerHTML = '';
        contentLayer.appendChild(text);
        text.textContent = val;
        item.style.width = 'auto'; item.style.height = 'auto';
        item.style.minWidth = '120px'; item.style.minHeight = '80px';
      }
      contentLayer.style.padding = $('#pad').value + 'px';
    }

    function levelTemplate(i){
      const div = document.createElement('div');
      div.className = 'level';
      div.innerHTML = `
        <div class="level-header">
           <h3>–£–†–û–í–ï–ù–¨ ${i+1}</h3>
           <button class="btn-danger del">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
        <input type="text" class="target" placeholder="–¶–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: Past Simple)" style="margin-bottom:8px">
        <div class="row">
           <textarea class="correct" placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω–æ..."></textarea>
           <textarea class="wrong" placeholder="–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ..."></textarea>
        </div>
        <label>–¢–∞–π–º–µ—Ä (—Å–µ–∫)</label>
        <input type="number" class="timer" value="30" style="width:80px">
      `;
      div.querySelector('.del').onclick = () => { div.remove(); };
      return div;
    }

    function addLevel(){ $('#levels').appendChild(levelTemplate($$('#levels .level').length)); }

    function collectConfig(){
      const levels = [];
      $$('.level').forEach(l => {
        levels.push({
          target: l.querySelector('.target').value.trim(),
          correct: l.querySelector('.correct').value.split('\n').filter(s=>s.trim()),
          wrong: l.querySelector('.wrong').value.split('\n').filter(s=>s.trim()),
          timer: l.querySelector('.timer').value
        });
      });

      return {
        language: $('#language').value,
        font: $('#font').value,
        fontSize: $('#fontSize').value,
        textColor: $('#textColor').value,
        speed: $('#speed').value,
        style: {
          shape: $('#shape').value,
          pad: $('#pad').value,
          bgColor: $('#bgColor').value,
          bgImages: ($('#bgImages').value||'').split('\n').filter(s=>s.trim()),
          borderOn: $('#borderOn').checked,
          borderColor: $('#borderColor').value,
          borderWidth: $('#borderWidth').value,
          shadow: $('#shadowOn').checked,
          glow: $('#glowOn').checked,
          glowColor: $('#glowColor').value,
          fx3d: $('#fx3d').checked,
          opacity: $('#opacity').value,
          imgBox: $('#imgBox').value
        },
        player: {
          img: $('#playerImg').value.trim(),
          width: $('#playerWidth').value,
          height: $('#playerHeight').value
        },
        direction: $('#direction').value,
        start: { title: $('#startTitle').value, btnText: $('#startBtnText').value },
        finalFeedback: $('#finalFeedback').value,
        levels: levels
      };
    }

    const ENDPOINT = "https://server-kjnn.onrender.com/publish";
    const KEY = "nika_read_pub_2025";
    const BASE = "https://nikashum93.github.io/catcher/main.html";

    async function publish(){
      const cfg = collectConfig();
      if(!cfg.levels.length || !cfg.levels[0].target) return alert("–î–æ–±–∞–≤—å —É—Ä–æ–≤–µ–Ω—å!");
      
      const btn = $('#saveBtnTop');
      const oldTxt = btn.textContent;
      btn.textContent = "‚è≥...";
      btn.disabled = true;

      const id = (cfg.levels[0].target.replace(/[^a-z0-9]/gi,'-') + '-' + Date.now()).toLowerCase();
      
      try {
        const res = await fetch(ENDPOINT, {
           method:'POST',
           headers: {'Content-Type':'application/json', 'X-Publish-Key': KEY},
           body: JSON.stringify({ id, mode:'json', folder:'data', content: JSON.stringify(cfg) })
        });
        if(!res.ok) throw new Error();
        
        const code = `<iframe src="${BASE}?id=${id}" width="900" height="600" style="border:0" allow="autoplay; fullscreen"></iframe>`;
        $('#iframeOut').value = code;
        alert("‚úÖ –ò–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞!");
      } catch(e) {
        alert("‚ùå –û—à–∏–±–∫–∞.");
      }
      btn.textContent = oldTxt;
      btn.disabled = false;
    }
    
    init();
  </script>
</body>
</html>
