<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catcher Game</title>
  <style>
    :root{ --ui: #ffd700; --glow: #00f0ff; }
    html,body{height:100%}
    body{ margin:0; background: transparent; color:#fff; overflow:hidden; font-family:system-ui,sans-serif; }
    #game{ position:relative; width:100%; height:100%; overflow:hidden; }

    /* HUD (ВЕРХНЯЯ ПАНЕЛЬ) */
    .hud{
      position:fixed; left:12px; top:12px; right:12px; display:flex; gap:12px; 
      justify-content:space-between; font-weight:700; z-index:20; pointer-events:none;
    }
    .badge{
      /* Тёмный стиль плашек */
      background:rgba(0,0,0,.65); 
      border:1px solid rgba(255,255,255,.2);
      border-radius:12px; padding:10px 16px; 
      backdrop-filter:blur(6px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      color: var(--ui);
      font-size: 18px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .levelTitle{ 
      color:#fff; 
      text-shadow: 0 0 10px var(--glow);
      max-width: 50%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
    }

    /* ИГРОК */
    #player {
      position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
      z-index: 100; pointer-events: none; background-position: bottom center; 
      background-size: contain; background-repeat: no-repeat; will-change: left;
    }
    
    .touch-zone { position: fixed; top:0; bottom:0; width: 50%; z-index: 5; }
    #zoneL { left: 0; } #zoneR { right: 0; }

    /* OVERLAYS (ТЁМНЫЙ ДИЗАЙН) */
    .overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column;
      background: rgba(0,0,0,0.8); /* Тёмное затемнение */
      backdrop-filter:blur(8px); z-index:500;
    }
    .overlay .panel{
      background: #1a1a1a; 
      color:#fff; border:1px solid #333; border-radius:24px; 
      padding:40px; text-align:center; 
      box-shadow:0 20px 60px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,215,0,0.1);
      max-width: 480px; width: 90%;
    }
    .overlay h2{ margin:0 0 16px; font-size:32px; color:var(--ui); text-shadow: 0 0 20px rgba(255,215,0,0.3); }
    .overlay p { color: #ccc; font-size: 18px; margin-bottom: 24px; }
    
    .overlay button{
      background: linear-gradient(135deg, #ffd700, #ffbf00); 
      color:#000; border:0; border-radius:12px; 
      padding:16px 32px; font-size:18px; font-weight:800; cursor:pointer; 
      box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2); 
      transition: transform 0.1s, box-shadow 0.1s;
    }
    .overlay button:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(255, 215, 0, 0.4); }

    /* ПАДАЮЩИЕ ЭЛЕМЕНТЫ */
    .item{
      position:absolute; top:-200px; left:0; transform:translateZ(0);
      display:inline-flex; align-items:center; justify-content:center;
      min-width:100px; min-height:80px; padding:0; user-select:none; cursor:pointer;
      z-index: 10;
    }
    
    /* СЛОЙ ФОНА (Плашка) - Эффекты применяются СЮДА */
    .item .bg{
      position:absolute; inset:0; background: transparent; z-index: 0;
      background-position:center !important; background-size: cover !important;
      transition:filter .15s; border-radius: 16px;
    }
    
    /* СЛОЙ ТЕКСТА - Чистый текст без эффектов плашки */
    .item .content{
      position:relative; z-index: 2; 
      display:flex; align-items:center; justify-content:center;
      text-align:center; padding: 12px;
      width: var(--cw, auto); height: var(--ch, auto);
      /* Легкая тень только для читаемости текста */
      text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 5px rgba(0,0,0,0.5);
      font-weight: 700;
      line-height: 1.2;
    }
    .item .content img{ width:100%; height:100%; object-fit:contain; pointer-events:none; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
    
    /* ФИГУРЫ И ЭФФЕКТЫ (Только для .bg) */
    .shape-rect .bg { border-radius:8px }
    .shape-rounded .bg { border-radius:20px }
    .shape-circle .bg { border-radius:50% }
    .shape-diamond .bg { clip-path:polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%) }
    .shape-star .bg { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
    
    .fx-shadow .bg{ box-shadow:0 10px 25px rgba(0,0,0,0.4) }
    .fx-glow .bg{ box-shadow:0 0 15px var(--glow), inset 0 0 10px var(--glow) }
    .fx-3d .bg{ box-shadow:0 6px 0 rgba(0,0,0,0.3) }

    .score-float{
      position:fixed; z-index:30; font-weight:900; font-size:28px;
      text-shadow: 2px 2px 0 #000;
      animation:floatUp .8s ease-out forwards; pointer-events:none;
    }
    @keyframes floatUp{ 0%{ transform:translate(-50%,0); opacity:1 } 100%{ transform:translate(-50%,-60px); opacity:0 } }
    .caught{ transform: scale(1.2); opacity: 0; transition: all 0.3s; }
    
    /* Красный тинт ошибки - только на фон */
    .tint-red .bg { animation: redFlash 0.4s; }
    @keyframes redFlash { 0%, 100% { background-color: transparent; } 50% { background-color: rgba(255,0,0,0.5); } }
  </style>
</head>
<body>
  <div class="hud">
    <div class="badge levelTitle" id="hudLevel">...</div>
    <div class="badge timer" id="hudTimer">00</div>
    <div class="badge score" id="hudScore">0</div>
  </div>
  <div id="game">
    <div id="touchLayer" style="display:none">
       <div id="zoneL" class="touch-zone"></div>
       <div id="zoneR" class="touch-zone"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <script>
    const $ = sel => document.querySelector(sel);
    const rnd = (a,b)=> a + Math.random()*(b-a);
    
    // ВШИТЫЕ ЗВУКИ (BASE64) - РЕШЕНИЕ ПРОБЛЕМЫ 404
    const SND = {
      pop: new Audio("data:audio/mp3;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAG1xUAALDkAALDkAAAL5hIAAAAB3MD+0AAFiigAAACgAAAAEAAAABAAAAAAEAAVwAAAAAA//uQZAUAB1WI0PZugAAAAAoAAAAENlI1BJJRgAAAAAoAAAAESTkUAADw8H9Bqd87576fn7t2tQEwCTv5pwcAA5N0O68brN1q8w16tWqWrVvrPBzRF+8nHGeKiZO05J08wN//uQZBmABfcjW90lAAPAAAAAAAB7DxOFQU4KAAAAACgAAAAxBMjCoVCqSauydM8yN//uQZBsABct4JAdpQAQAAAAAAABCwwMy67wbA9kTrp7slH/84e9m/7f/yH//uQZBwABf5JpQnmAAPAAAAAAABuJ+OPv39/394WHgAAAAB3IiAAuQAAAAAA//uQZB0ABi54oAdpQAQAAAAAAABC58O6778Lp9k7rq7slH/84e9m/7f/yH//uQZCAABfVJpQnmAAPAAAAAAABuJ+OPv39/394WHgAAAAB3IiAAuQAAAAAA//uQZCEABi54oAdpQAQAAAAAAABC58O6778Lp9k7rq7slH/84e9m/7f/yH//uQZCUABfVJpQnmAAPAAAAAAABuJ+OPv39/394WHgAAAAB3IiAAuQAAAAAA"),
      wrong: new Audio("data:audio/mp3;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAG1xUAALDkAALDkAAAL5hIAAAAB3MD+0AAFiigAAACgAAAAEAAAABAAAAAAEAAVwAAAAAA//uQZAUAB1WI0PZugAAAAAoAAAAENlI1BJJRgAAAAAoAAAAESTkUAADw8H9Bqd87576fn7t2tQEwCTv5pwcAA5N0O68brN1q8w16tWqWrVvrPBzRF+8nHGeKiZO05J08wN//uQZBmABfcjW90lAAPAAAAAAAB7DxOFQU4KAAAAACgAAAAxBMjCoVCqSauydM8yN//uQZBsABct4JAdpQAQAAAAAAABCwwMy67wbA9kTrp7slH/84e9m/7f/yH//uQZBwABf5JpQnmAAPAAAAAAABuJ+OPv39/394WHgAAAAB3IiAAuQAAAAAA//uQZB0ABi54oAdpQAQAAAAAAABC58O6778Lp9k7rq7slH/84e9m/7f/yH//uQZCAABfVJpQnmAAPAAAAAAABuJ+OPv39/394WHgAAAAB3IiAAuQAAAAAA//uQZCEABi54oAdpQAQAAAAAAABC58O6778Lp9k7rq7slH/84e9m/7f/yH//uQZCUABfVJpQnmAAPAAAAAAABuJ+OPv39/394WHgAAAAB3IiAAuQAAAAAA"),
      win: new Audio("data:audio/mp3;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAG1xUAALDkAALDkAAAL5hIAAAAB3MD+0AAFiigAAACgAAAAEAAAABAAAAAAEAAVwAAAAAA//uQZAUAB1WI0PZugAAAAAoAAAAENlI1BJJRgAAAAAoAAAAESTkUAADw8H9Bqd87576fn7t2tQEwCTv5pwcAA5N0O68brN1q8w16tWqWrVvrPBzRF+8nHGeKiZO05J08wN//uQZBmABfcjW90lAAPAAAAAAAB7DxOFQU4KAAAAACgAAAAxBMjCoVCqSauydM8yN//uQZBsABct4JAdpQAQAAAAAAABCwwMy67wbA9kTrp7slH/84e9m/7f/yH//uQZBwABf5JpQnmAAPAAAAAAABuJ+OPv39/394WHgAAAAB3IiAAuQAAAAAA")
    };
    
    let cfg = null;
    let playerNode = null, playerPos = {x:0, v:0}, keys = {l:false, r:false};
    let score=0, running=false, currentLevel=0;
    
    const params = new URLSearchParams(location.search);
    const ID = params.get('id');
    const URL = `https://nikashum93.github.io/texts/data/${ID}.json`;

    if(!ID) {
      document.body.innerHTML = "<h2 style='text-align:center; color:#fff; margin-top:50px'>Нет ID игры.</h2>";
    } else {
      fetch(URL).then(r=>r.json()).then(startApp).catch(e=>{
        console.error(e);
        document.body.innerHTML = "<h2 style='text-align:center; color:#fff; margin-top:50px'>Ошибка загрузки.</h2>";
      });
    }

    function startApp(data){
      cfg = data;
      // Шрифты
      if(cfg.font) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = `https://fonts.googleapis.com/css2?family=${cfg.font.replace(/ /g,'+')}:wght@400;700&display=swap`;
        document.head.appendChild(link);
      }
      if(cfg.style?.glowColor) document.documentElement.style.setProperty('--glow', cfg.style.glowColor);
      
      setupBackground();
      setupPlayer();
      
      const ov = document.createElement('div'); ov.className='overlay';
      const startTitle = cfg.start?.title || 'Game';
      const startBtn = cfg.start?.btnText || 'Start';
      ov.innerHTML = `<div class="panel"><h2>${startTitle}</h2><button id="btnStart">${startBtn}</button></div>`;
      document.body.appendChild(ov);
      $('#btnStart').onclick = () => { ov.remove(); startGame(); };
    }

    function setupBackground(){
      const img = document.createElement('div');
      img.style.cssText = "position:fixed;inset:0;z-index:-1;background-size:cover;background-position:center;transition:background-image 0.5s";
      document.body.appendChild(img);
      const list = cfg.style?.bgImages || [];
      if(list.length) img.style.backgroundImage = `url(${list[0]})`;
      else if(cfg.style?.bgImage) img.style.backgroundImage = `url(${cfg.style.bgImage})`;
      else {
        // ЕСЛИ ФОНА НЕТ — ПРОЗРАЧНОСТЬ (ДЛЯ GENIALLY)
        img.style.backgroundColor = 'transparent';
      }
      
      window.nextBg = () => {
         if(list.length) img.style.backgroundImage = `url(${list[Math.floor(Math.random()*list.length)]})`;
      };
    }

    function setupPlayer(){
      if(!cfg.player?.img) return; 
      playerNode = document.createElement('div');
      playerNode.id = 'player';
      playerNode.style.width = (cfg.player.width||100)+'px';
      playerNode.style.height = (cfg.player.height||100)+'px';
      playerNode.style.backgroundImage = `url(${cfg.player.img})`;
      $('#game').appendChild(playerNode);
      $('#touchLayer').style.display = 'block';
      
      playerPos.x = window.innerWidth/2;
      
      window.onkeydown = e => { if(e.key==='ArrowLeft') keys.l=true; if(e.key==='ArrowRight') keys.r=true; };
      window.onkeyup = e => { if(e.key==='ArrowLeft') keys.l=false; if(e.key==='ArrowRight') keys.r=false; };
      
      const L=$('#zoneL'), R=$('#zoneR');
      const downL = (e) => { if(e.preventDefault) e.preventDefault(); keys.l = true; };
      const upL   = (e) => { if(e.preventDefault) e.preventDefault(); keys.l = false; };
      const downR = (e) => { if(e.preventDefault) e.preventDefault(); keys.r = true; };
      const upR   = (e) => { if(e.preventDefault) e.preventDefault(); keys.r = false; };

      L.ontouchstart = downL; L.ontouchend = upL;
      L.onmousedown = downL; L.onmouseup = upL; L.onmouseleave = upL;
      R.ontouchstart = downR; R.ontouchend = upR;
      R.onmousedown = downR; R.onmouseup = upR; R.onmouseleave = upR;
      
      requestAnimationFrame(loopPlayer);
    }

    function loopPlayer(){
      if(!playerNode || !running) { requestAnimationFrame(loopPlayer); return; }
      if(keys.l) playerPos.v -= 1.5;
      if(keys.r) playerPos.v += 1.5;
      playerPos.v *= 0.85;
      playerPos.x += playerPos.v;
      
      const w = playerNode.offsetWidth;
      if(playerPos.x < w/2) { playerPos.x = w/2; playerPos.v=0; }
      if(playerPos.x > window.innerWidth - w/2) { playerPos.x = window.innerWidth - w/2; playerPos.v=0; }
      
      playerNode.style.left = playerPos.x + 'px';
      checkCollisions();
      requestAnimationFrame(loopPlayer);
    }

    function startGame(){
      score=0; currentLevel=0; running=true;
      $('#hudScore').textContent = '0';
      startLevel();
    }

    function startLevel(){
      currentLevel++;
      if(currentLevel > cfg.levels.length) { gameOver(); return; }
      
      window.nextBg();
      const lv = cfg.levels[currentLevel-1];
      
      // ИСПРАВЛЕНИЕ: ВЫВОДИМ ТОЛЬКО TARGET (Цель)
      $('#hudLevel').textContent = lv.target || `Уровень ${currentLevel}`;
      
      let time = lv.timer || 30;
      $('#hudTimer').textContent = time;
      
      const timer = setInterval(() => {
        if(!running) return clearInterval(timer);
        time--;
        $('#hudTimer').textContent = time;
        if(time <= 0) {
          clearInterval(timer);
          document.querySelectorAll('.item').forEach(e=>e.remove());
          showLevelComplete();
        }
      }, 1000);
      
      spawnLoop(lv);
    }

    function spawnLoop(lv){
      const pool = [...lv.correct.map(v=>({v,g:true})), ...lv.wrong.map(v=>({v,g:false}))];
      
      const next = () => {
         if(!running) return;
         if(document.querySelectorAll('.item').length < 6) drop(pool[Math.floor(Math.random()*pool.length)]);
         setTimeout(next, 1500 - (cfg.speed*100));
      };
      next();
    }

    function drop(data){
      const el = document.createElement('div');
      const sty = cfg.style;
      el.className = `item shape-${sty.shape} ${sty.shadow?'fx-shadow':''} ${sty.fx3d?'fx-3d':''} ${sty.glow?'fx-glow':''}`;
      el.dataset.good = data.g;

      // СЛОЙ ФОНА (Плашка)
      const bg = document.createElement('div'); bg.className = 'bg';
      if(sty.bgImages?.length) bg.style.backgroundImage = `url(${sty.bgImages[0]})`;
      else bg.style.backgroundColor = sty.bgColor || 'rgba(255,255,255,0.2)';
      
      // Прозрачность применяется ТОЛЬКО к фону
      bg.style.opacity = sty.opacity || 1;
      
      if(sty.borderOn) bg.style.border = `2px solid ${sty.borderColor}`;

      // СЛОЙ КОНТЕНТА (Текст/Картинка)
      const con = document.createElement('div'); con.className = 'content';
      if(data.v.startsWith('http')){
        con.innerHTML = `<img src="${data.v}">`;
        con.style.setProperty('--cw', sty.imgBox+'px'); con.style.setProperty('--ch', sty.imgBox+'px');
      } else {
        con.textContent = data.v;
        con.style.fontSize = (cfg.fontSize||24)+'px';
        con.style.fontFamily = cfg.font;
        con.style.color = cfg.textColor;
        if(cfg.language==='math') { con.textContent = `\\(${data.v}\\)`; MathJax.typesetPromise([con]); }
      }

      el.appendChild(bg); el.appendChild(con);
      el.style.left = rnd(20, window.innerWidth-100)+'px';
      
      if(!playerNode) el.onclick = () => catchItem(el);

      $('#game').appendChild(el);
      
      let y = -150;
      const speed = 1 + (cfg.speed*0.5);
      const dir = cfg.direction === 'up' ? -1 : 1;
      if(dir === -1) { y = window.innerHeight + 50; el.style.top = y+'px'; }

      function fall(){
        if(!el.parentNode) return;
        y += speed * dir;
        el.style.top = y + 'px';
        if(y > window.innerHeight+100 || y < -200) el.remove();
        else requestAnimationFrame(fall);
      }
      requestAnimationFrame(fall);
    }

    function checkCollisions(){
      const pRect = playerNode.getBoundingClientRect();
      const hit = { l: pRect.left+20, r: pRect.right-20, t: pRect.top+20, b: pRect.bottom-10 };

      document.querySelectorAll('.item').forEach(el => {
        if(el.dataset.caught) return;
        const r = el.getBoundingClientRect();
        if(!(hit.r < r.left || hit.l > r.right || hit.b < r.top || hit.t > r.bottom)){
           catchItem(el);
        }
      });
    }

    function catchItem(el){
      el.dataset.caught = true;
      const isGood = el.dataset.good === 'true';
      
      if(isGood) {
        score += 10;
        floatText(el, "+10", "#0f0");
        try{ SND.pop.currentTime=0; SND.pop.play() }catch(e){}
      } else {
        score = Math.max(0, score-10);
        floatText(el, "-10", "#f00");
        try{ SND.wrong.currentTime=0; SND.wrong.play() }catch(e){}
        if(playerNode) {
            playerNode.style.filter = "grayscale(1) sepia(1) hue-rotate(-50deg) saturate(5)";
            setTimeout(()=>playerNode.style.filter="", 300);
        }
        el.classList.add('tint-red');
      }
      $('#hudScore').textContent = score;
      el.classList.add('caught');
      setTimeout(()=>el.remove(), 200);
    }

    function floatText(el, txt, col){
       const f = document.createElement('div'); f.className='score-float';
       f.textContent = txt; f.style.color = col;
       const r = el.getBoundingClientRect();
       f.style.left = (r.left+r.width/2)+'px'; f.style.top = r.top+'px';
       document.body.appendChild(f);
       setTimeout(()=>f.remove(), 800);
    }

    function showLevelComplete(){
      const ov = document.createElement('div'); ov.className='overlay';
      try{ SND.win.currentTime=0; SND.win.play() }catch(e){}
      ov.innerHTML = `<div class="panel"><h2>Level Complete!</h2><button onclick="this.closest('.overlay').remove();startLevel()">Next</button></div>`;
      document.body.appendChild(ov);
    }
    
    function gameOver(){
      const ov = document.createElement('div'); ov.className='overlay';
      try{ SND.win.currentTime=0; SND.win.play() }catch(e){}
      const fb = cfg.finalFeedback || 'Good Job!';
      ov.innerHTML = `<div class="panel"><h2>${fb}</h2><p>Score: ${score}</p><button onclick="location.reload()">Replay</button></div>`;
      document.body.appendChild(ov);
    }
  </script>
</body>
</html>
